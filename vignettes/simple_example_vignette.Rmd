---
title: "Simple Example for r2ogs5"
author: Philipp Schad
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{simple_example_vingette}
  %\VignetteKeyword{HTML}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(r2ogs)
```

## Table of contents

1. [Installation](#inst)
2. [Setting up a simulation manually](#sim1)
3. [Modifying a simulation object and writing input files](#mod) 
4. [Settining up a simulation from input files](#sim2)
5. [Run simulations and retrieve output](#run)

## Installation <a name="inst"></a>

The first option for installation is directly from the online repository via
```{r, eval=FALSE}
devtools::install_gitlab("online/repo/path")
```
in your R console.  

The second option is first cloning the repository by typing in a terminal 
```{bash, eval = FALSE}
git clone online/repo/path
```
and then installing from the local repository via
```{r, eval=FALSE}
devtools::install("local/repo/path")
```
in your R console  

Note that it is necessary to have git https://www.git-scm.com/
and/or the R-package `devtools` installed on your system. 
  


## Setting up a simulation <a name="sim"></a>

On the basis of a very simple hydraulic transport flow model, the basic functions
to create input, run a simulation and retrieve output 

The functions to set up a simulation from scratch follow the pattern 
`input_add_<file extension>bloc()` and can be used repeatedly to add new input 
blocs to the simulation. Before staring to add blocs, a simulation object of 
class *ogs5* has to be created, where this blocs are added. This is done using
the assign operator ( `<-` ) and the function \code{\link[r2ogs::create_ogs5]{r2ogs::create_ogs5()}}. 
```{r}
ex1 <- create_ogs5(sim_name = "ex1",
                   sim_id = 1L,
                   sim_path = "inst/examples/tmp/ex1")
```

Now, the first input bloc can be created. In this case a process-bloc for a waterflow process. 
```{r}
ex1 <- input_add_pcs_bloc(x=ex1, pcs_name = "waterflow", PCS_TYPE = "LIQUID_FLOW",
                          PRIMARY_VARIABLE = "PRESSURE1")
```
Depending on the process, there are different arguments that need to be
specified in the above function. In general, all uppercase arguments are
equivalent to **ogs5** keywords and can be looked up on https://ogs5-keywords.netlify.app/ogs/wiki/public/doc-auto.   

In the following, more `pcs` blocs will be added to `ex1` and other blocs in 
the same fashion. 
```{r}
ex1 <- input_add_pcs_bloc(x=ex1, pcs_name = "tracer",
                          PCS_TYPE = "MASS_TRANSPORT",
                          PRIMARY_VARIABLE = "Tracer1",
                          RELOAD = c("1", "1"))

ex1 <- input_add_bc_bloc(x=ex1, bc_name = "pressure_out",
                         PRIMARY_VARIABLE = "PRESSURE1",
                         DIS_TYPE = "CONSTANT 9810",
                         PCS_TYPE = "LIQUID_FLOW",
                         GEO_TYPE = "POINT point1")

ex1 <- input_add_bc_bloc(x=ex1, bc_name = "tracer_in",
                         PRIMARY_VARIABLE = "Tracer",
                         DIS_TYPE = "CONSTANT 1.19438",
                         PCS_TYPE = "MASS_TRANSPORT",
                         GEO_TYPE = "POINT point0",
                         TIM_TYPE = "CURVE 1")

ex1 <- input_add_ic_bloc(x = ex1, ic_name = "pressure",
                         PCS_TYPE = "LIQUID_FLOW",
                         PRIMARY_VARIABLE = "PRESSURE1",
                         GEO_TYPE = "DOMAIN",
                         DIS_TYPE = "CONSTANT 9810")

ex1 <- input_add_ic_bloc(x = ex1, ic_name = "tracer",
                         PCS_TYPE = "MASS_TRANSPORT",
                         PRIMARY_VARIABLE = "Tracer",
                         GEO_TYPE = "DOMAIN",
                         DIS_TYPE = "CONSTANT 0.0")

ex1 <- input_add_mcp_bloc(x = ex1,
                          NAME = "Tracer",
                          MOBILE = 1)

ex1 <- input_add_mfp_bloc(x = ex1, FLUID_NAME = "water",
                          FLUID_TYPE = "LIQUID",
                          DENSITY = "1 1.0E+3",
                          VISCOSITY = "1 1.0E-3")

ex1 <- input_add_mmp_bloc(x = ex1, GEOMETRY_DIMENSION = "1",
                          GEOMETRY_AREA = "1.2",
                          POROSITY = "1 0.38",
                          PERMEABILITY_TENSOR = "ISOTROPIC 1.0E-8",
                          MASS_DISPERSION = "1 1.0",
                          TORTUOSITY = "1 1.0",
                          NAME = "gravel")

ex1 <- input_add_msp_bloc(x = ex1, NAME = "gravel" ,
                          DENSITY = "1 1.8E+3")

ex1 <- input_add_num_bloc(x = ex1, num_name = "waterflow",
                          PCS_TYPE = "LIQUID_FLOW",
                          LINEAR_SOLVER = "2 6 1.0E-14 100 1.0 100 4")

ex1 <- input_add_num_bloc(x = ex1, num_name = "tracer",
                          PCS_TYPE = "MASS_TRANSPORT",
                          LINEAR_SOLVER = "2 6 1.0E-14 100 1.0 100 4")

ex1 <- input_add_out_bloc(x = ex1, out_name = "waterflow",
                          PCS_TYPE = "LIQUID_FLOW",
                          NOD_VALUES = "PRESSURE1\n VELOCITY_X1",
                          GEO_TYPE = "DOMAIN",
                          DAT_TYPE = "PVD",
                          TIM_TYPE = "STEPS 10")

ex1 <- input_add_out_bloc(x = ex1, out_name = "tracer",
                          PCS_TYPE = "MASS_TRANSPORT",
                          NOD_VALUES = "Tracer",
                          GEO_TYPE = "DOMAIN",
                          DAT_TYPE = "PVD",
                          TIM_TYPE = "STEPS 10")

ex1 <- input_add_out_bloc(x = ex1, out_name = "tracer_tec",
                          PCS_TYPE = "MASS_TRANSPORT",
                          NOD_VALUES = "Tracer",
                          GEO_TYPE = "DOMAIN",
                          DAT_TYPE = "TECPLOT", TIM_TYPE = "STEPS 1")

ex1 <- input_add_st_bloc(x = ex1, st_name = "waterflow",
                         PCS_TYPE = "LIQUID_FLOW",
                         PRIMARY_VARIABLE = "PRESSURE1",
                         GEO_TYPE = "POINT point0",
                         DIS_TYPE = "CONSTANT_NEUMANN 7.8611E-06")

ex1 <- input_add_tim_bloc(x = ex1,  tim_name = "waterflow",
                          PCS_TYPE = "LIQUID_FLOW",
                          TIME_START = "0",
                          TIME_END = "36000000",
                          TIME_STEPS = "229 3600")

ex1 <- input_add_tim_bloc(x = ex1,  tim_name = "tracer",
                          PCS_TYPE = "MASS_TRANSPORT",
                          TIME_START = "0",
                          TIME_END = "36000000",
                          TIME_STEPS = "229 3600")

```

Next, an `rfd` bloc with a time series of tracer concentrations at one point 
will be generated. 

```{r}
# add rfd
ex1 <- input_add_rfd_bloc(x = ex1, rfd_name = "tracer", mkey = "CURVES",
                          data = tibble::tibble(time=c(0, 3600, 3600.1, 720, 36000000),
                                                conc=c(1,1,0,0,0)))
```

Finally, two geometry blocs are created and added to the `ex1`. First, a `gli` 
bloc with three dimensional coordinates $x, y, z$ for two points is added. Then a `msh` bloc is created 
via two helper functions. Here, only a one dimensional mesh (on $x$) is created. In order to create a $3d$ mesh, for example, the arguments `ly`, `lz`, `ny` and `nz` have to be specified accordingly. For further options please refer to the function documentation. 

```{r}
# add gli
ex1 <- input_add_gli_points(x = ex1,
                            ogs5_points = tibble::tibble(x = c(0, 4.7),
                                                         y = c(0,0),
                                                         z = c(0,0),
                                                         name = c("point0", "point1")))
# ad msh bloc
mesh_lst <- r2ogs:::create_structured_mesh_nodes_ele(lx = 4.7, nx = 94)
ex1 <- input_add_msh_bloc(x = ex1, msh_name = "base_mesh",
                          NODES = mesh_lst$NODES,
                          ELEMENTS = list(nodes = mesh_lst$ELEMENTS)) #TODO: change after bugfix!
```
The names of the points are also used in the boundary condition blocs (`bc`), which
have been added before and can be looked up via 
```{r}
ex1$input$bc$tracer_in$GEO_TYPE
ex1$input$bc$pressure_out$GEO_TYPE
```

In order to review the simulation object, the function `str` might be helpful 
(output not shown).
```{r, eval = FALSE}
str(ex1)
```


## Modifying a simulation object and writing input files <a name="mod"></a> 

In order to overwrite an existing input bloc the entry has to be deleted first.
Then a new bloc with the same name as before but different values can be added. 
```{r}
ex1$input$msp <- NULL
ex1 <- input_add_msp_bloc(ex1,
                          NAME = "gravel",
                          DENSITY = "1 1.79e+3")
```
Alternatively, an entry can also be changed directly by assigning a new character 
string. Here, care has to be taken to include all necessary specifications and
follow the format requirements such as whitespaces and line breaks. 
```{r}
ex1$input$msp$gravel$DENSITY <- "1 1.8E+3"
str(ex1$input$msp)
```

The helper function [cal_change_parameters()] to use for calibration can also be used for this purpose. For more see `vignette("calibration"). 

All blocs can be written out by setting `type = "all`, which is the default 
or only a selection of bloc types. Note that r2ogs will always create directories
where none exist and overwrite existing directories. 
```{r,eval=TRUE}
ogs5_write_inputfiles(ex1, type = "all")

ogs5_write_inputfiles(ex1, type = "bc", folderpath = "inst/examples/tmp/ex1")

ogs5_write_inputfiles(ex1, type = c("bc", "mmp"))
```
If no `folderpath` is specified, the files will be written into the folder specified
at initialization with `sim_path`. 

## Settining up a simulation from input files <a name="sim2"></a>

The function `input_add_blocs_from_file()` can be used to create *ogs* 
simulation objects directly from the input files in an automatized fashion. As
before, an *ogs5*-object needs to bee initialized first.

For example, all files from the directory *inst/examples/tmp/ex1* can be read in and *r2ogs* will print the reading progress.
```{r, eval=TRUE, results="markup", echo=TRUE}
ex2 <- create_ogs5(sim_name = "ex2",
                   sim_id = 1L,
                   sim_path = "inst/examples/tmp/ex2")

ex2 <- input_add_blocs_from_file(ex2,
                                 sim_basename = "ex1",
                                 filename = "all",
                                 file_dir = "inst/examples/tmp/ex1"
                                 )
```
The argument `sim_basename` should to correspond to the common file-basename in the directory. The function will automatically assign the blocs with the corresponding classes and place them into the correct location in `ex2`. 
```{r}
ex2$input$gli
```
Except of \*.tec, \*.vtk, \*.pvd all kinds of files that are in the directory are read in. Files that are not among the basic *OGS5* files are added into `input$additional`. 
It is important to have 'clean' input files in the directory, best without any comments (\\\\). Furthermore, a single input file or a list of inputfiles can be specified explicitly, to avoid reading any unnecessary files from the directory.
```{r}
ex2 <- input_add_blocs_from_file(ex2,
                                 sim_basename = "ex1",
                                 filename = list("ex1.bc",
                                                 "ex1.mmp"),
                                 file_dir = "inst/examples/tmp/ex1"
                                 )
```

## Run simulations and retrieve output <a name="run"></a>  

If the simulation object is ready and written to a directory, the simulation can finally be handed over to *OGS5* via a wrapper function, as shown below with all arguments set to default. 
```{r, eval=TRUE}
ogs5_run(ex1,
         ogs_exe = "../inst/ogs/ogs", 
         run_path = attributes(ex1)$sim_path,
         log_output = TRUE,
         log_path = paste0(attributes(ex1)$sim_path, "/log"), 
         use_mpi = FALSE,
         wait = TRUE)
```
In order to run, an appropriate *OGS5* executable should be provided. Depending on the type of simulation, special compiling options need to be set. For a download an compilation guide of *OGS5* refer to https://github.com/ufz/ogs5. 
The argument `log_output` allows to write the *OGS5* output into a file specified under `log_path` or display the output in the console by setting `log_output` to `FALSE`. 
For Parallelized simulation, `use_mpi` must be set to true, the `number_of_cores` specified and an appropriate *OGS5* executable provided, of course.


The output files specified in `input$out` are written into the same directory where
the input files lie. 
```{r}
str(ex1$input$out)
```
Here we have two *"PVD"* and one "*TECPLOT*" as output files. The first stores every
10th time step of the variable **Pressure**, the second of **Tracer** and the last 
every time step of **Tracer** over the whole geometrical domain of the model. 

The "tecplot" output can be added to the `ex1$output` via
```{r}
ex1$output <- ogs5_read_many_tecplots(filepath = attributes(ex1)$sim_path,
                  geo_object = "domain")
ex1$output
```
which yields a regular *tibble* with the observed variable in time and space.
depending on its dimensionality, results can then be easily plotted.

```{r, message=FALSE, results='hide'}
library(dplyr)
library(ggplot2)
breakthrough <- ex1$output %>%
  select(TIME, X, Tracer) %>% 
  filter(X == 4.7)

ggplot(breakthrough, aes(x = TIME, y = Tracer)) +
  geom_point() +
  labs(title = "Tracer concentration at the end of the model domain") +
  theme_minimal()

ggplot(ex1$output, aes(x = X, y = Tracer, color = log(TIME))) +
  geom_point() + 
  labs(title = "Change of tracer distribution on the model domain") +
  theme_minimal()
  
```



