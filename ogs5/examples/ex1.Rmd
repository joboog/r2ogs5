---
title: "Example 1: Single OGS5 simulation."
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, results = "hide",
                      error = FALSE, message = FALSE)
```


In this example, a single serial ogs5 simulation will be defined and
executed. Then the output will be retrieved.

## Preambel

```{r}
library(tidyverse)
library(BBmisc)
library(reticulate)
use_condaenv("py3env")

sources = list.files(path = "ogs5/input/",
                     pattern="*.R$", full.names=TRUE, 
                     ignore.case=TRUE)
sapply(sources, source, .GlobalEnv)

sources = list.files(path = "ogs5/output/",
                     pattern="*.R$", full.names=TRUE, 
                     ignore.case=TRUE)
sapply(sources, source, .GlobalEnv)

sources = list.files(path =  "ogs5/base/",
                     pattern="*.R$", full.names=TRUE, 
                     ignore.case=TRUE)
sapply(sources, source, .GlobalEnv)
```


## Define Model

Define ogs5 object.
```{r}
ex1 <- create_ogs5(sim_name = "ex1", sim_id = 1L, sim_path = "ogs5/examples/tmp/ex1")
```


## Add Inputfile Blocs

GLI
```{r}
ex1 <- input_add_gli_points(x = ex1, 
                            ogs5_points = tibble(x = c(0, 4.7), y = c(0,0), 
                                                z = c(0,0), 
                                                name = c("point0", "point1")))
```

MSH
```{r}
mesh_lst <- create_structured_mesh_nodes_ele(lx = 4.7, nx = 94)
ex1 <- input_add_msh_bloc(x = ex1, msh_name = "base_mesh", 
                          NODES = mesh_lst[[1]],
                          ELEMENTS = mesh_lst[[2]])
```

PCS
```{r}
ex1 <- input_add_pcs_bloc(x=ex1, pcs_name = "waterflow", PCS_TYPE = "LIQUID_FLOW", 
                          PRIMARY_VARIABLE = "PRESSURE1")

ex1 <- input_add_pcs_bloc(x=ex1, pcs_name = "tracer", PCS_TYPE = "MASS_TRANSPORT", 
                          PRIMARY_VARIABLE = "Tracer1", RELOAD = c("1", "1"))
```

BC
```{r}
ex1 <- input_add_bc_bloc(x=ex1, bc_name = "pressure_out", PRIMARY_VARIABLE = "PRESSURE1",
                         DIS_TYPE = "CONSTANT 9810", PCS_TYPE = "LIQUID_FLOW",
                         GEO_TYPE = "POINT point1")

ex1 <- input_add_bc_bloc(x=ex1, bc_name = "tracer_in", PRIMARY_VARIABLE = "Tracer",
                         DIS_TYPE = "CONSTANT 1.19438", PCS_TYPE = "MASS_TRANSPORT",
                         GEO_TYPE = "POINT point0", TIM_TYPE = "CURVE 1")
```

IC
```{r}
ex1 <- input_add_ic_bloc(x = ex1, ic_name = "pressure", PCS_TYPE = "LIQUID_FLOW",
                         PRIMARY_VARIABLE = "PRESSURE1", GEO_TYPE = "DOMAIN",
                         DIS_TYPE = "CONSTANT 9810")

ex1 <- input_add_ic_bloc(x = ex1, ic_name = "tracer", PCS_TYPE = "MASS_TRANSPORT",
                         PRIMARY_VARIABLE = "Tracer", GEO_TYPE = "DOMAIN",
                         DIS_TYPE = "CONSTANT 0.0")
```

MCP
```{r}
ex1 <- input_add_mcp_bloc(x = ex1, NAME = "Tracer", MOBILE = 1)
```

MFP
```{r}
ex1 <- input_add_mfp_bloc(x = ex1, FLUID_NAME = "water", FLUID_TYPE = "LIQUID", 
                          DENSITY = "1 1.0E+3", VISCOSITY = "1 1.0E-3")
```

MMP
```{r}
ex1 <- input_add_mmp_bloc(x = ex1, 
                          GEOMETRY_DIMENSION = "1", GEOMETRY_AREA = "1.2", 
                          POROSITY = "1 0.38", PERMEABILITY_TENSOR = "ISOTROPIC 1.0E-8", 
                          MASS_DISPERSION = "1 1.0", TORTUOSITY = "1 1.0", 
                          NAME = "gravel")
```

MSP
```{r}
ex1 <- input_add_msp_bloc(x = ex1, NAME = "gravel" , DENSITY = "1 1.8E+3")
```

NUM
```{r}
ex1 <- input_add_num_bloc(x = ex1, num_name = "waterflow", PCS_TYPE = "LIQUID_FLOW",
                          LINEAR_SOLVER = "2 6 1.0E-14 100 1.0 100 4")

ex1 <- input_add_num_bloc(x = ex1, num_name = "tracer", PCS_TYPE = "MASS_TRANSPORT",
                          LINEAR_SOLVER = "2 6 1.0E-14 100 1.0 100 4")
```

OUT
```{r}
ex1 <- input_add_out_bloc(x = ex1, out_name = "waterflow", PCS_TYPE = "LIQUID_FLOW",
                          NOD_VALUES = "PRESSURE1\n VELOCITY_X1", GEO_TYPE = "DOMAIN",
                          DAT_TYPE = "PVD", TIM_TYPE = "STEPS 10")

ex1 <- input_add_out_bloc(x = ex1, out_name = "tracer", PCS_TYPE = "MASS_TRANSPORT",
                          NOD_VALUES = "Tracer", GEO_TYPE = "DOMAIN",
                          DAT_TYPE = "PVD", TIM_TYPE = "STEPS 10")

ex1 <- input_add_out_bloc(x = ex1, out_name = "tracer_tec", PCS_TYPE = "MASS_TRANSPORT",
                          NOD_VALUES = "Tracer", GEO_TYPE = "DOMAIN",
                          DAT_TYPE = "TECPLOT", TIM_TYPE = "STEPS 1")
```

ST
```{r}
ex1 <- input_add_st_bloc(x = ex1, st_name = "waterflow", PCS_TYPE = "LIQUID_FLOW",
                         PRIMARY_VARIABLE = "PRESSURE1", GEO_TYPE = "POINT point0",
                         DIS_TYPE = "CONSTANT_NEUMANN 7.8611E-06")
```

TIM
```{r}
ex1 <- input_add_tim_bloc(x = ex1,  tim_name = "waterflow", 
                          PCS_TYPE = "LIQUID_FLOW", TIME_START = "0",
                          TIME_END = "36000000", TIME_STEPS = "229 3600")

ex1 <- input_add_tim_bloc(x = ex1,  tim_name = "tracer", 
                          PCS_TYPE = "MASS_TRANSPORT", TIME_START = "0",
                          TIME_END = "36000000", TIME_STEPS = "229 3600")
```

RFD
```{r}
ex1 <- input_add_rfd_bloc(x = ex1, rfd_name = "tracer", mkey = "CURVES", 
                          data = tibble(time=c(0, 3600, 3600.1, 720, 36000000),
                                        conc=c(1,1,0,0,0)))
```


## Run Simulation

Write inputfiles.
```{r}
# write all files
ogs5_write_inputfiles(ex1, "all")
```

Run ogs5 simulation

```{r eval = FALSE}
ogs5_run(ogs5_obj = ex1, 
         exe_path = "/home/boog/ufz/08_hiwi_envinf/03_ogs5/ogs_5.76/bin",
         run_path = NULL,
         log_output = TRUE,
         log_path = "example/ex1/log")
```


## Post-Process

Read TEC output.
```{r eval = FALSE}
tec_df <- ogs5_read_many_tecplots(filepath = "ogs5/examples/tmp/ex1",
                                  geo_object = "domain")
```

Read specific OUT bloc
```{r eval = FALSE}
ex1 <- ogs5_get_output_specific(ex1, outbloc_names = "tracer")
```

Read all output.
```{r eval = FALSE}
ex1 <- ogs5_get_output_all(ex1)
```

Read output at sepcific nodes.
```{r eval = FALSE}
foo <- ogs5_read_data_at_nodes(ex1, outbloc_name = "waterflow",
                           node_coords = tibble(x=c(2,5), y=c(0,0), z=c(0,0)))
```


## Visualize


```{r eval = FALSE}
df <- ex1$output$tracer_tec[[1]] %>% 
      filter(X == 4.7)

qplot(TIME, Tracer, geom = "line", data = df )
```

